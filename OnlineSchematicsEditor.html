<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Schematics Editor — MVP</title>
  <!-- Prevent /favicon.ico 404s -->
  <link rel="icon" type="image/svg+xml" href="assets/schematics-favicon.svg">
  <link rel="mask-icon" href="assets/schematics-mask.svg" color="#0ea5e9">
  <style>
    :root{
      --bg:#0f1115; --panel:#161a22; --ink:#e6e6e6; --muted:#a5adbb; --accent:#61dafb; --danger:#ff6b6b; --ok:#4ade80;
      --grid:#2a2f3a; --grid-bold:#3a4150; --wire:#c7f284; --select:#f59e0b; --pin:#93c5fd; --component:#e2e8f0; --ghost:#64748b;
    }
    html, body {height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--ink); background:var(--bg);}
    .app{display:grid; grid-template-columns: 320px 1fr 320px; grid-template-rows:auto 1fr; height:100%;}
  header{grid-column: 1/4; display:flex; align-items:center; gap:.25rem; padding:.5rem .75rem; background:var(--panel); border-bottom:1px solid #22262f; position:sticky; top:0; z-index:3}
    /* Keep everything on one row (no wrap); we'll popup sub-types absolutely */
    header{ flex-wrap: nowrap; align-items: center; }
  /* Thin vertical separator between mode buttons and components */
  .vsep{ width:1px; height:32px; background:#22262f; margin:0 .125rem; border-radius:1px; }
    /* Sub-type popup: small, only as wide as content, positioned under the Diode button */
    #paletteRow2{
      position:absolute;
      display:none;
      width:max-content;            /* only as wide as its contents */
      pointer-events:auto;
      z-index:5;                    /* above header background */
    }
    #paletteRow2 select{ width:auto; white-space:nowrap; }
  header .group{display:flex; gap:.15rem; align-items:center; background:#0e1219; padding:.22rem; border-radius:10px; border:1px solid #1e2430; position:relative}
    button{appearance:none; background:#0e1219; border:1px solid #273042; color:var(--ink); padding:.45rem .6rem; border-radius:8px; cursor:pointer; font-size:.92rem}
    button:hover{border-color:#3a4a68}
    button.active{outline:2px solid var(--accent);}
    button.danger{border-color:#623; color:#ffb3c7}
    button.ok{border-color:#1b3; color:#bff7d0}
    #left, #right{background:var(--panel); border-right:1px solid #22262f;}
    #right{border-right:none; border-left:1px solid #22262f}
    #left, #right{padding:.75rem; overflow:auto}
    h2{margin:.25rem 0 .5rem; font-size:1.05rem; color:#cbd5e1}
    .row{display:flex; gap:.5rem; align-items:center; margin:.4rem 0}
    label{color:var(--muted); font-size:.9rem}
    input[type="text"], select, input[type="number"]{width:100%; background:#0e1219; color:var(--ink); border:1px solid #273042; border-radius:8px; padding:.4rem .5rem}
    input[type="file"]{width:100%}
    .hint{color:#9aa3b2; font-size:.85rem;}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:.05rem .35rem; background:#0b0f16; border:1px solid #273042; border-radius:6px}
    #editorWrap{position:relative;}
    #svg{width:100%; height:calc(100vh - 64px); display:block; background:var(--bg);}
    .overlayTip{position:absolute; left:10px; bottom:10px; background:rgba(14,18,25,.75); border:1px solid #273042; padding:.35rem .5rem; border-radius:8px; font-size:.85rem}
    /* Hover cues for hit-testing feedback */
    .wire-stroke{transition:stroke .08s ease, filter .08s ease}
    .wire-stroke.hover{stroke:var(--select); filter:drop-shadow(0 0 2px rgba(245,158,11,.6))}
    /* Selected component: tint only its symbol graphics (not pins/text/hitbox) */
    #components g.comp.selected > g line,
    #components g.comp.selected > g path,
    #components g.comp.selected > g polyline,
    #components g.comp.selected > g circle {
      stroke: var(--select) !important;
      filter: drop-shadow(0 0 2px rgba(245,158,11,.6));
    }
    /* If a symbol element is filled (e.g., transistor arrow), color its fill too */
    #components g.comp.selected > g [fill="var(--component)"] {
      fill: var(--select) !important;
    }
    
    /* Keep strokes visually consistent when zooming the SVG viewBox */
    svg line, svg path, svg polyline, svg circle { vector-effect: non-scaling-stroke; }
    /* Crosshair overlay while wiring */
    body.mode-wire #svg{ cursor: crosshair; }
    /* Pan cursors */
    body.mode-pan #svg{ cursor: grab; }
    body.mode-pan.panning #svg{ cursor: grabbing; }
    /* Also show grabbing during mid-mouse pan even if not in Pan mode */
    body.panning #svg{ cursor: grabbing; }
    /* Crosshair styles are now set inline via JavaScript based on mode */
    /* Marquee selection box (drawn in #overlay) */
    #overlay rect.marquee {
      fill: rgba(245, 158, 11, 0.12);   /* subtle fill */
      stroke: var(--select);
      stroke-width: 2;
      stroke-dasharray: 6 4;
      pointer-events: none;
    }
    /* Inspector value + units on a single line, no wrapping */
    #inspector .hstack{ display:flex; gap:8px; align-items:center; }
    #inspector .hstack input[type="text"]{ flex:1 1 0; min-width:0; }     /* wide value box */
    /* Units dropdown: measure to content via JS, but cap visually via CSS too */
    #inspector .hstack select{
      flex:0 0 auto;
      min-width:72px;
      max-width:50%;                 /* hard cap: never exceed half the row */
      white-space:nowrap;
      width:auto;                    /* prevent global select{width:100%} */
    }
    /* Swatch-only dropdowns */
    #wireColorGroup{ position:relative; }
    .palette{
      position:absolute; top:100%; left:0; margin-top:6px;
      background:#0e1219; border:1px solid #273042; padding:6px;
      border-radius:8px; display:grid; grid-template-columns: repeat(7, 20px);
      gap:6px; z-index:7;
    }
    .palette .swatch-btn{
      width:20px; height:20px; border:1px solid #273042; border-radius:4px; cursor:pointer;
    }
    .palette .swatch-btn.selected{ outline:2px solid var(--accent); }
    #wireColorBtn .swatch{ width:16px; height:16px; }
    /* Inspector wire-color holder must be relative for its palette */
    .inspector-color{ position:relative; }
    .inspector-color .palette{ top:calc(100% + 6px); left:0; }    
    /* Grid button dim/off visual */
    .group button.dim{ color:var(--muted); opacity:0.75; font-weight:400 }
    /* Grid ON: green outline */
    .group button.grid-on{ box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.15), inset 0 0 0 1px var(--ok); }
    /* Grid OFF: red outline */
    .group button.grid-off{ box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.12), inset 0 0 0 1px var(--danger); }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="group" id="modeGroup">
      <button data-mode="select" class="active" title="Select/Move (V)">Select</button>
      <button data-mode="wire" title="Wire (W)">Wire</button>
      <button data-mode="delete" title="Delete (Del)">Delete</button>
      <button data-mode="pan" title="Pan (P or MMB drag)">Pan</button>
      <button data-mode="move" title="Move selected (M / Arrow keys)">Move</button>
      <button id="orthoToggleBtn" title="Ortho mode (O)">Ortho</button>
      <button id="gridToggleBtn" title="Toggle Grid (G)">Grid</button>
      <button id="crosshairToggleBtn" title="Toggle Crosshair Length (X)">+</button>
      <button id="junctionDotsBtn" title="Toggle Junction Dots">.</button>
      <button id="trackingToggleBtn" title="Toggle Tracking (T)">- -</button>
    </div>
    <div class="vsep"></div> 
  <div class="group" id="paletteRow1">
      <button data-tool="resistor" title="Place Resistor (R)">Resistor</button>
      <button data-tool="capacitor" title="Place Capacitor (C)">Capacitor</button>
      <button data-tool="inductor" title="Place Inductor (L)">Inductor</button>
      <button data-tool="diode" title="Place Diode (D)">Diode</button>
      <button data-tool="npn" title="Place NPN">NPN</button>
      <button data-tool="pnp" title="Place PNP">PNP</button>
      <button data-tool="ground" title="Place Ground">GND</button>
      <button data-tool="battery" title="Place Battery">Battery</button>
      <button data-tool="ac" title="Place AC Source">AC Source</button>
    </div>
    <!-- Sub-type row (appears when a type with subtypes is active; for now: Diode) -->
    <div class="group" id="paletteRow2" style="display:none">
      <select id="diodeSelect" title="Diode subtype">
        <option value="generic" selected>Generic</option>
        <option value="schottky">Schottky</option>
        <option value="zener">Zener</option>
        <option value="led">Light-emitting (LED)</option>
        <option value="photo">Photo</option>
        <option value="tunnel">Tunnel</option>
        <option value="varactor">Varactor / Varicap</option>
        <option value="laser">Laser</option>
      </select>
    </div>    
    <div class="group">
      <button id="rotateBtn" title="Rotate 90° (R)">Rotate</button>
      <button id="clearBtn" class="danger" title="Clear (Ctrl+K)">Clear</button>
    </div>
    <div class="group" id="wireColorGroup" title="Wire color (new wires only)">
      <button id="wireColorBtn" title="Wire color">
        <span style="color:#9aa3b2;margin-right:.25rem">Wire</span>
        <span id="wireColorSwatch" class="swatch"></span>
      </button>
      <div id="wireColorMenu" class="palette" style="display:none"></div>
    </div>    
    <div class="group">
      <button id="zoomOutBtn" title="Zoom Out (−)">−</button>
      <button id="zoomInBtn" title="Zoom In (+)">+</button>
      <button id="zoomResetBtn" title="Reset Zoom (1:1)">100%</button>
      <input id="zoomPct" type="text" value="100%" title="Zoom % (editable)" style="width:6ch;text-align:right" />      
    </div>    
    <div class="group">
      <button id="saveBtn" class="ok" title="Save JSON (Ctrl+S)">Save</button>
      <button id="loadBtn" title="Load JSON">Load</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
    </div>
    <div style="margin-left:auto; color:#9aa3b2">Grid: <span id="gridSizeKbd" class="kbd">24px</span> · Snap: <span id="snapKbd" class="kbd">on</span></div>
  </header>
  <aside id="left">
    <h2>Inspector </h2>
    <div id="inspectorNone" class="hint">Select a component or wire to edit its properties.</div>
    <div id="inspector"></div>
    <hr style="border-color:#22262f; margin:1rem 0" />
    <h2>Tips</h2>
    <ul class="hint" style="line-height:1.5">
      <li><span class="kbd">V</span> Select/Move · <span class="kbd">W</span> Wire · <span class="kbd">Del</span> Delete</li>
      <li>Click grid to place selected part. Drag to move. <span class="kbd">R</span> rotates a part.</li>
      <li>Wiring: click start → click turns → double‑click or <span class="kbd">Enter</span> to finish. <span class="kbd">Esc</span> to cancel.</li>
      <li>Select: click-drag on empty space to draw a marquee window. Release to select (by default, the nearest <em>wire segment</em> in the box). Hold <span class="kbd">Shift</span> while dragging to prefer <em>components</em> instead. Click empty space to clear.</li>
      <li>Delete: click a wire <em>segment</em> or component to remove.</li>
    </ul>
  </aside>
  <main id="center">
    <div id="editorWrap">
      <svg id="svg" viewBox="0 0 1600 1000" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="grid" width="24" height="24" patternUnits="userSpaceOnUse">
            <path d="M24 0H0V24" fill="none" stroke="var(--grid)" stroke-width="1" />
          </pattern>
          <pattern id="gridBold" width="120" height="120" patternUnits="userSpaceOnUse">
            <rect width="120" height="120" fill="url(#grid)"/>
            <path d="M120 0H0V120" fill="none" stroke="var(--grid-bold)" stroke-width="1.5" />
          </pattern>
          <!-- Marker for wire endpoints when drawing -->
          <marker id="dot" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="5" markerHeight="5">
            <circle cx="5" cy="5" r="3" fill="var(--wire)" />
          </marker>
        </defs>
        <rect id="gridRect" x="0" y="0" width="1600" height="1000" fill="url(#gridBold)" />
        <g id="dotGrid"></g>
        <g id="wires"></g>
        <g id="junctions"></g>
        <g id="components"></g>
        <g id="drawing"></g>
        <g id="overlay" class="crosshair"></g>
      </svg>
      <div class="overlayTip" id="overlayTip">Mode: <b id="modeLabel">Select</b></div>
    </div>
  </main>
  <aside id="right">
    <h2>Project</h2>
    <div class="row"><label>Title</label></div>
    <div class="row"><input id="projTitle" type="text" placeholder="Untitled schematic" /></div>
    <div class="row hint">Saved into JSON</div>
    <hr style="border-color:#22262f; margin:1rem 0" />
    <h2>Counts</h2>
    <div class="hint" id="counts">—</div>
  </aside>
</div>

<!-- NEW: works from file:// (classic) and http(s) (module) -->
<script>
(function () {
  var s = document.createElement('script');
  if (location.protocol === 'file:') {
    // Classic script works when opened directly from disk (avoids CORS on module scripts)
    s.src = 'dist/app.js';
  } else {
    // Keep ESM when served over http(s)
    s.type = 'module';
    s.src = 'dist/app.js';
  }
  document.currentScript.replaceWith(s);
})();
</script>

</body>
</html>
